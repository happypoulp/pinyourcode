(function(){var e="models/extension";define("models/extension",[],function(){log(e,"Dependencies loaded","Build module");var t=Backbone.Model.extend({idAttribute:"_id",urlRoot:function(){return"/api/friends/"+this.friend_id+"/extensions"},defaults:{name:"",tags:[],content:""}});return t})})(),function(){var e="collections/extensions";define("collections/extensions",["models/extension"],function(t){log(e,"Dependencies loaded","Build module");var n=Backbone.Collection.extend({model:t,url:function(){return console.log("COLLECTION URL called",this.options,this.options.friend_id),"/api/friends/"+this.options.friend_id+"/extensions"},initialize:function(e,t){this.friend=t.friend}});return n})}(),function(){var e="models/friend";define("models/friend",["collections/extensions"],function(t){log(e,"Dependencies loaded","Build module");var n=Backbone.Model.extend({idAttribute:"_id",urlRoot:"/api/friends",defaults:{extensions:[],fb_id:null,user_id:null,name:null,picture:null,picture_small:null},parse:function(e){return e.extensions=new t(e.extensions,{friend:this}),e},addExtension:function(e){this.get("extensions").add(e)}});return n})}();var jd_rt="jade-runtime";define("templates/friend/item",[jd_rt],function(){return function(e){var t=[],n=e||{},r=n.friend,i=r.fb_id,s=r.extensions.length;return t.push('<div class="profile_pic"><img'+jade.attrs({src:""+r.picture_small+"",width:"50",height:"50"},{src:!0,width:!0,height:!0})+'/></div><span class="name">'+jade.escape(null==(jade.interp=r.name)?"":jade.interp)+"</span><div"+jade.attrs({title:""+s+" extensions","class":["extensions_count"]},{title:!0})+">"+jade.escape(null==(jade.interp=s)?"":jade.interp)+'</div><div class="tools"><button class="button red js-remove_fb_friend">Remove</button></div>'),t.join("")}}),function(){var e="views/friend/item";define("views/friend/item",["templates/friend/item"],function(t){log(e,"Dependencies loaded","Build module");var n=Backbone.View.extend({name:e,tagName:"li",className:"fb_friend list-item",events:{"click .js-remove_fb_friend":"remove"},remove:function(e){e.stopPropagation(),confirm("Are you sure you want to delete this friend and all his extensions?")&&this.model.destroy({success:function(){$(e.target).closest(".fb_friend").remove()},error:function(){console.log("ERROR!")}})},render:function(){log(e,"==== render",this.cid),this.$el.attr("data-uid",this.model.get("fb_id")).attr("data-id",this.model.id).addClass(this.options.extraClass).html(t({friend:this.model.attributes}))},beforeRemove:function(e){return this.model.off("change",this.getRenderProxy()),this},getRenderProxy:function(){return this.renderProxy||(this.renderProxy=$.proxy(this.render,this))},initialize:function(){this.model.on("change",this.getRenderProxy())}});return n})}();var jd_rt="jade-runtime";define("templates/candidate/item",[jd_rt],function(){return function(e){var t=[],n=e||{},r=n.candidate,i=r.fb_id||r.id;return t.push('<div class="profile_pic"><img'+jade.attrs({src:""+r.picture_small+"",width:"50",height:"50"},{src:!0,width:!0,height:!0})+'/></div><span class="name">'+jade.escape(null==(jade.interp=r.name)?"":jade.interp)+"</span>"),t.join("")}}),function(){var e="views/candidate/item";define("views/candidate/item",["templates/candidate/item"],function(t){log(e,"Dependencies loaded","Build module");var n=Backbone.View.extend({name:e,tagName:"li",className:"fb_candidate list-item",events:{click:"add"},add:function(e){e.stopPropagation(),this.model.save(null,{success:function(){document.location.hash="/"}})},render:function(){return this.$el.attr("data-uid",this.model.get("fb_id")).addClass(this.options.extraClass).html(t({candidate:this.model.attributes})),this}});return n})}();var jd_rt="jade-runtime";define("templates/candidate/empty",[jd_rt],function(){return function(e){var t=[],n=e||{},r=n.search;return t.push("<center>No results for this search: <b>"+jade.escape(null==(jade.interp=r)?"":jade.interp)+"</b><br/><br/>Maybe this person is already in your extended contacts?\nOr you could you have possibly misspelled his or her name?</center>"),t.join("")}}),function(){var e="views/candidate/empty";define("views/candidate/empty",["templates/candidate/empty"],function(t){log(e,"Dependencies loaded","Build module");var n=Backbone.View.extend({className:"emptyresults",render:function(){this.$el.html(t({search:this.options.search}))}});return n})}(),function(){var e="views/candidate/results",t="facebook";define("views/candidate/results",[t,"models/friend","views/candidate/item","views/candidate/empty"],function(t,n,r,i){log(e,"Dependencies loaded","Build module");var s=Backbone.View.extend({name:e,tagName:"ul",id:"fb_search_results",search:"",UIDs:[],results:[],events:{},setSearch:function(e){return this.search=e,this},setResults:function(e){return this.results=e,this},empty:function(){this.$el.empty(),this.UIDs=[],this.results=[]},update:function(){log(e,"result",this.results,"search",this.search);if(!this.search){this.clean(),this.empty();return}this.needFBRendering=!0;var t=!1,s=this,o=_.map(this.results,function(e){return e.uid});log(e,"resultUIDs",o);if(!this.results.length)log(e,"results empty"),this.clean().renderChild(new i({search:this.search}),{meth:"html",target:this.$el}),this.needFBRendering=!1;else{log(e,"has results");var u=[],a=[],f=[];log(e,"current UIDS",this.UIDs),this.UIDs.length?(log(e,"children",this.children.length,"resultUIDs",o),_.each(this.children,function(t){log(e,"child",t,t.model);if(t.model){var n=t.model.get("fb_id");log(e,"UID",n,o.indexOf(n)),o.indexOf(n)==-1?(log(e,t.model.get("name"),"not present in results, remove it"),a.push(t),s.UIDs.splice(s.UIDs.indexOf(n),1)):(log(e,t.model.get("name"),"already present"),f.push(n))}})):(log(e,"CLEAR current result content."),this.clean().$el.empty()),_.each(a,function(e){e.remove()});var u=_.difference(o,f);u.length&&(_.each(this.results,function(t){if(u.indexOf(t.uid)==-1)return;log(e,"add child",t),s.renderChild(new r({model:new n({fb_id:t.uid,name:t.name,picture:t.pic_big,picture_small:t.pic_square})}),{meth:"prepend",target:s.$el})}),this.needFBRendering=!0)}this.UIDs=o},render:function(){var t=this,s=$.Deferred(),o=[];if(!this.results.length)log(e,"results empty"),o.push(this.renderChild(new i({search:this.search}))),this.needFBRendering=!1;else{var u=_.map(this.results,function(e){return e.uid});_.each(this.results,function(e){o.push(t.renderChild(new r({model:new n({fb_id:e.uid,name:e.name,picture:e.pic_big,picture_small:e.pic_square})})))}),this.UIDs=u,this.needFBRendering=!0}return $.when.apply($,o).then(function(){s.resolve()}),s}});return s})}(),function(){var e="views/generic";define("views/generic",[],function(){log(e,"Dependencies loaded","Build module");var t=Backbone.View.extend({name:e,render:function(){this.$el.html(this.options.template(this.options.data))}});return t})}();var jd_rt="jade-runtime";define("templates/friend/add",[jd_rt],function(){return function(e){var t=[];return t.push('<h2>Add a friend</h2><div id="friend_search"><form id="add_friend_form" action="/friends" method="post"><input type="text" name="friend_name" placeholder="John Doe"/></form></div>'),t.join("")}}),function(){var e="views/friend/add",t="pubsub",n="facebook";define("views/friend/add",[t,n,"models/friend","views/friend/item","views/candidate/results","views/generic","templates/friend/add"],function(t,n,r,i,s,o,u){log(e,"Dependencies loaded","Build module");var a=Backbone.View.extend({name:e,events:{'keyup input[name="friend_name"]':"onInputKeyUp","submit #add_friend_form":"onFormSubmit"},onInputKeyUp:function(e){var t=this;clearTimeout(this.inputTO),this.inputTO=setTimeout(function(){var r=$.trim($(e.target).val());if(t.lastSearch===r)return;console.log("search",r),n.searchFriend(r,$.proxy(t.searchFriendCallback,t)),t.lastSearch=r},150)},onFormSubmit:function(e){e.preventDefault()},searchFriendCallback:function(e,t){var n=!1;this.resultsView||(n=!0,console.log("ResultsView",s),this.resultsView=new s),this.resultsView.setSearch(e).setResults(t),n?this.renderChild(this.resultsView,{meth:"after",target:"#friend_search"}):this.resultsView.update()},render:function(){t.publish("header:any"),this.renderChild(new o({template:u}))},postRender:function(){this.$el.find('input[name="friend_name"]').focus()}});return a})}();